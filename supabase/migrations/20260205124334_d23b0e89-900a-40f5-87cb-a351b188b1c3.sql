
-- =============================================================================
-- Migration: Create device mapping table and update devices
-- Part 1/3: Setup mapping and update serial devices with MAC addresses
-- =============================================================================

-- Create persistent mapping table
CREATE TABLE IF NOT EXISTS device_serial_mac_map (
    serial TEXT PRIMARY KEY,
    mac TEXT NOT NULL
);

-- Clear and repopulate
DELETE FROM device_serial_mac_map;

-- Insert all mappings
INSERT INTO device_serial_mac_map (serial, mac) VALUES
('2412270001', '5031860D7853'), ('2412270002', '50316DF94151'), ('2412270003', '50315D7C3627'),
('2412270004', '5031A833101B'), ('2412270005', '5031AF29D332'), ('2412270006', '50319CF44829'),
('2412270007', '5031073DED11'), ('2412270008', '503179FF70DA'), ('2412270009', '503105FD1993'),
('2412270010', '50316646F5D8'), ('2412270011', '50319C8422DD'), ('2412270012', '503119D19A9A'),
('2412270013', '5031B7A9711E'), ('2412270014', '5031F05B5C0A'), ('2412270015', '50316F4A54A5'),
('2412270016', '503192CD32D1'), ('2412270017', '5031B737158B'), ('2412270018', '50312D16C2A8'),
('2412270019', '50316760E627'), ('2412270020', '50310B2691A1'), ('2412270021', '5031E88C9693'),
('2412270022', '5031C318A384'), ('2412270023', '50318D0E3B8D'), ('2412270024', '50317B4C652E'),
('2412270025', '5031EF285EAA'), ('2412270026', '50314480BF4B'), ('2412270027', '50319F35AD15'),
('2412270028', '5031713BCC39'), ('2412270029', '5031CF0C7379'), ('2412270030', '5031268DFFE2'),
('2412270031', '5031E2FFD9C2'), ('2412270032', '5031C8839ECE'), ('2412270033', '5031313A41A1'),
('2412270034', '50317FE0440B'), ('2412270035', '50310C4B55B8'), ('2412270036', '5031C8F499FE'),
('2412270037', '5031015138B6'), ('2412270038', '5031C0AE4188'), ('2412270039', '503185017709'),
('2412270040', '50316ED6AA0C'), ('2412270041', '50315A814D23'), ('2412270042', '503176560820'),
('2412270043', '5031883B7582'), ('2412270044', '5031B2E9C466'), ('2412270045', '503172F39F49'),
('2412270046', '503126FAF8D2'), ('2412270047', '50312A2C6E04'), ('2412270048', '50319C13F004'),
('2412270049', '50311A6C329D'), ('2412270050', '5031EB83124B'), ('2412270051', '50316DFE2C95'),
('2412270052', '5031EF5F599A'), ('2412270053', '5031EE085754'), ('2412270054', '5031CB357CC2'),
('2412270055', '5031FF4B4224'), ('2412270056', '5031463D7137'), ('2412270057', '50318A63FF94'),
('2412270058', '5031DF34208D'), ('2412270059', '5031523C2D78'), ('2412270060', '50316D6B020B'),
('2412270061', '5031EC9EBCA6'), ('2412270062', '5031C475679D'), ('2412270063', '503162B78186'),
('2412270064', '50318CE3D815'), ('2412270065', '5031F46E747E'), ('2412270066', '5031560522C3'),
('2412270067', '50313798F5E2'), ('2412270068', '50318B8E1C0C'), ('2412270069', '5031C6C8A9E1'),
('2412270070', '5031750218000000'), ('2412270071', '5031D7A7F4DB'), ('2412270072', '503164DD4E20'),
('2412270073', '503172FA2905'), ('2412270074', '5031518ACF74'), ('2412270075', '503108E7749D'),
('2412270076', '50310290DD8A'), ('2412270077', '5031545DA8D5'), ('2412270078', '503105F4AFDF'),
('2412270079', '5031EA6F8616'), ('2412270080', '5031F30F97A8'), ('2412270081', '50312904E89D'),
('2412270082', '50312BE095DC'), ('2412270083', '50318987E4AE'), ('2412270084', '5031C030251D'),
('2412270085', '50315551E961'), ('2412270086', '5031FBE4E883'), ('2412270087', '503195F8E954'),
('2412270088', '503169520DB0'), ('2412270089', '5031E835F047'), ('2412270090', '50310461E73A'),
('2412270091', '5031B10DDF5C'), ('2412270092', '5031D859E494'), ('2412270093', '503165807D20'),
('2412270094', '5031FF4C2FE0'), ('2412270095', '503112874DB6'), ('2412270096', '50314A5C5ABD'),
('2412270097', '5031253B1DEE'), ('2412270098', '50310CF2336C'), ('2412270099', '5031EC0B495C'),
('2412270100', '5031E2453494'), ('2503040001', '503180AFCC10'), ('2503040004', '5031D2594AB3'),
('2503040006', '50319858690C'), ('2503040007', '5031788D8012'), ('2503040008', '50315ECAD42B'),
('2503040009', '5031B41F9312'), ('2504090005', '5031971DE3D0'), ('2504090006', '5031769F0400'),
('2504090008', '50312419E857'), ('2504090009', '5031A0BBDB7C'), ('2504090010', '5031FC7FB648'),
('2504090011', '5031A0D0AEB9'), ('2504090013', '5031957974B6'), ('2504090014', '50318FF5130F'),
('2504090015', '50316F1C4BD5'), ('2501090002', '5031951376B6'), ('2504090017', '50319A9731C3'),
('2504090021', '503181122AF9'), ('2504090022', '503168E8869D'), ('2504090023', '5031FCFBBA29'),
('2504090024', '503183A5D94B'), ('2504090025', '50315E0C7446'), ('2504090026', '50318FC9A2CB'),
('2504090029', '503175FA2E6C'), ('2504090030', '5031D7A0991F'), ('2504090031', '5031C430A655'),
('2504090032', '50311F3D09AE'), ('2504090033', '503171F3B7DC'), ('2504090034', '503112F5DB05'),
('2504090035', '503116C0F371'), ('2504090037', '5031B002156A'), ('2504090038', '5031E01AD346'),
('2504090040', '50319263B79F'), ('2504090041', '50310C5191F8'), ('2504090042', '503168718FCC'),
('2504090043', '5031DD04F868'), ('2504090046', '5031E53234CD'), ('2504090049', '50311F76BF5A'),
('2504160001', '5031531ED8C1'), ('2504160002', '503134B4953D'), ('2504160003', '5031BA0A7AC4'),
('2504160004', '503102D27186'), ('2504160005', '5031621B23EB'), ('2504160006', '50312AC26065'),
('2504160007', '5031AE60534E'), ('2504160008', '5031AA03C8FE'), ('2504160009', '50314703F67B'),
('2509290001', '5031E434D1A9'), ('2504160011', '5031D96763D8'), ('2509290002', '5031460CA553'),
('2504160013', '5031399DE5BA'), ('2504160014', '50318C1542C7'), ('2504160015', '5031151C137D'),
('2504160016', '5031AA4CEF9C'), ('2504160017', '50319F79DA91'), ('2504160018', '503105E7DDD3'),
('2509290003', '503167E7546E'), ('2509290004', '50315294F04D'), ('2504160021', '50319558C042'),
('2504160022', '5031C3B36C2D'), ('2504160023', '503143B3A5AB'), ('2509290005', '5031418802EF'),
('2504160025', '50319699257E'), ('2504160026', '5031E19E15E8'), ('2509290006', '50312B4848E9'),
('2504160028', '5031B4A6F5C6'), ('2509290007', '50310D2073AC'), ('2504160030', '503172E0ED45'),
('2504160031', '50312DD8A34C'), ('2504160032', '5031B4B45CBB'), ('2504160033', '50315AC3E12F'),
('2504160034', '50311827CA87'), ('2504160035', '50317C6DD6B3'), ('2504160036', '50319BF44F40'),
('2509290008', '5031488828E9'), ('2504160038', '50312DC4D1B9'), ('2504160039', '503154041BE8'),
('2509290009', '5031C6A6780D'), ('2504160041', '503186345814'), ('2509290010', '50310D57749C'),
('2504160043', '5031B9403FD4'), ('2504160044', '503143380587'), ('2504160045', '5031C4BB0679'),
('2504160046', '5031343F3511'), ('2504160047', '50318FDA7C73'), ('2504160048', '5031CD0D4A52'),
('2504160049', '5031C3A1C550'), ('2504160050', '50315AA894EA'), ('2504160051', '5031A0A7A989'),
('2504160052', '50311271D764'), ('2509290011', '50310A4DB7B5'), ('2504160054', '5031231F598B'),
('2504160055', '5031A7D61F65'), ('2504160056', '50317B56A16E'), ('2504160057', '503102FD1EFA'),
('2504160058', '5031406E3262'), ('2504160059', '5031E87EEA07'), ('2504160060', '5031290B44D0'),
('2504160061', '50317177BBBD'), ('2504160062', '503123FF8C62'), ('2504160063', '5031AD3FD2E7'),
('2504160064', '5031D0CD5D06'), ('2504160065', '50314099A8A5'), ('2504160066', '50319242036B'),
('2504160067', '50312AB56755'), ('2504160068', '50316C5ECF4C'), ('2504160069', '50319235045B'),
('2504160070', '5031A40B88AC'), ('2504160071', '50314D682D99'), ('2504160072', '5031683A3938'),
('2504160073', '50315D39F7EF'), ('2504160074', '5031B3BC36EF'), ('2504160075', '50313D02D916'),
('2504160076', '5031F629ABAB'), ('2504160077', '5031CA0BFB8E'), ('2504160078', '50311B59FFDA'),
('2504160079', '5031DDD73008'), ('2504160080', '5031E25FF0D4'), ('2504160081', '5031BD7BCC28'),
('2504160082', '50313748B600'), ('2504160083', '503106708B2B'), ('2504160084', '50311C65E5C3'),
('2504160085', '5031BA160831'), ('2504160086', '50310B6AE625'), ('2504160087', '5031DE0AA7C1'),
('2504160088', '50314A05E980'), ('2504160089', '50311F4A0E9E'), ('2504160090', '5031EC8478E6'),
('2504160091', '5031DABAF411'), ('2504160092', '50315418691D'), ('2504160093', '5031CD1138A7'),
('2504160094', '5031D0D12FF3'), ('2504160095', '50315EEF5DFD'), ('2504160096', '50318B7886DE'),
('2504160097', '503149D87E49'), ('2504160098', '50316576E7F2'), ('2504160099', '503139B28AC6'),
('2504160100', '5031C4CC0149'), ('2508140001', '5031195628D3'), ('2508140002', '503193DDEF5E'),
('2508140003', '50317D4A8723'), ('2508140004', '5031E0C7F504'), ('2508140006', '50318D451467'),
('2508140007', '50311E8D8AE7'), ('2508140008', '5031BBF75578'), ('2508140009', '50310DB97AFD'),
('2508140010', '503104963F87'), ('2508140011', '503173E60821'), ('2508140012', '5031A802C47F'),
('2508140013', '503138E2DC66'), ('2508140014', '50312593C0DB'), ('2508140020', '503126739113'),
('2508140021', '503138BDD9EE'), ('2508140024', '5031178DA0E1'), ('2508140026', '5031E32E1280'),
('2508140029', '50319AF2AA24'), ('2508140030', '50314DF05F4E9'), ('2508140031', '5031A85DC1F7'),
('2508140034', '50312CE38029'), ('2508140037', '5031E4DADFC8'), ('2504160053', '5031FA5F146B'),
('2504160027', '5031812E9B3D'), ('2504160042', '5031A3664CB5'), ('2504160029', '50312DAFA47C'),
('2504160020', '50310B4B52D1'), ('2504160037', '503101983496'), ('2504160012', '50316E3FC9A9'),
('2504160019', '503124729D92'), ('2504160010', '50316F20FA11'), ('2504160040', '50319EABAFFB'),
('2504160024', '5031ADBDC487'), ('2508140036', '5031634B754B'), ('2504090020', '503129E86D6B'),
('2508140028', '50314FE5ECF0'), ('2508140022', '50310EC99428'), ('2508140039', '5031BC9A9161'),
('2508140040', '503119212FE3'), ('2508140032', '503113C639E9'), ('2508140023', '5031B6743127'),
('2508140033', '5031F9F4C6FD'), ('2508140016', '5031DF5AF161'), ('2508140018', '50318ACF6853'),
('2508140005', '503122FE04C2'), ('2508140027', '5031694BDB6C')
ON CONFLICT (serial) DO UPDATE SET mac = EXCLUDED.mac;

-- Update serial-based devices with correct MAC address
UPDATE devices d
SET 
    mac_address = m.mac,
    updated_at = now(),
    name = CASE 
        WHEN d.name LIKE 'BACKFILL%' OR d.name LIKE 'Auto:%' 
        THEN 'WEEL - ' || RIGHT(m.mac, 4)
        ELSE d.name
    END
FROM device_serial_mac_map m
WHERE d.device_id = m.serial
  AND d.device_type = 'air_quality';
